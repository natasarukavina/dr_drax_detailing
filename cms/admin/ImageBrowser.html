<section xx id="dropArea" class="componentSection" style="transition: border 2s; border: dashed {{drag?'8px #689':'8px #fff'}}">
    <div  style="display: flex;align-items: center;padding-bottom: 0; padding-top: 2rem;padding-bottom: 1rem; text-align: center;justify-content: center;">
        <input type="file" multiple name="file" id="file" class="inputfile">
        <label class="upload" for="file" >Upload file here</label>
         <span style="padding: 1rem;"> OR </span>     
        <div class="upload" style="border:dashed 1px #679" xx> Drag & Drop files here</div>
    </div>

    <div style="display: flex; align-items: center; padding-top: 1rem; justify-content: center;margin-bottom: 0.5rem;">
        <span class="hr"></span>
        <span class="subheader" xx="">or Select existing image</span>
        <span class="hr"></span>
    </div>
<!--
    <div style="display: flex;align-items: center;padding-bottom: 12px; justify-content: center;">
        <span class="subheader" xx>Select existing image</span>
    </div>
-->
    <grid style="flex:1; overflow:auto;">
        {{#each rows}}
        <div col='1/4' class="cardholder" on-dblclick="confirm" on-click="@this.fire('imgSelect', .)">
            <card style="{{imgSelect == .id?'box-shadow: 0 1px 4px 0 rgba(0,0,0,1)':''}}">
                <div xx class="img" style="background-image:url('{{HOSTNAME}}image.php?id={{id}}')">
                </div>
                <p xx class="carddesc">{{.name}}</p>
            </card>
        </div>
        {{/each}}

    </grid>
    <div xx class="buttonBar">
        <button disabled={{imgSelect?false:true}} on-click="delete">Delete file
        </button>    
        <button primary style="width: 14rem;" on-click="confirm">Confirm
        </button>    
    </div>
            
</section>

<style>
.upload {
    width: 22rem;
    margin: 0;
    cursor: pointer;
    color: #679;
    display: inline-block;
    padding: 1.4rem 2rem;
    background: #fff;
    border: 1px solid #679;
    border-radius: 2px;
    box-shadow: 0 0 0 transparent;
    text-transform: uppercase;
    text-decoration: none;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1rem;
    -webkit-appearance: none;
}
.upload:hover {
    box-shadow: 2px 2px 4px rgba(0,0,0,.3);
    background: #f4f5f6;
}

.inputfile {
	width: 0.1px;
	height: 0.1px;
	opacity: 0;
	overflow: hidden;
	position: absolute;
	z-index: -1;
}    

card {
    text-align: center;
    height: 220px;
    transition: box-shadow 1s;
}
card:hover {
    box-shadow: 0 1px 4px 0 rgba(0,0,0,1);
}
.carddesc{
    height: 54px;
    overflow: auto;
}
.img{
    background-repeat: no-repeat;
    background-position: center center;
    background-size: contain;
    width: 100%;
    height: 144px;
    margin-bottom: 1rem;   
}

.componentSection {
    flex:1; 
    padding-bottom:0; 
    padding:1rem; 
    overflow:auto; 
    display:flex; 
    flex-flow:column; 
    height:100%
}
.buttonBar{
    display:flex; 
    justify-content: space-between; 
    margin-top: 2rem;
}
.subheader {
    color: #679;
    font-size: 1.8rem;
    margin-right: 0.5rem;
    margin-left: 0.5rem;    
}    
.hr{
    flex: 1; background: 1px #679;height: 1px;
}
</style>
<script>
component.exports = {
    onteardown: function(){
        console.log('imgbroews teardown', this)
        this.nodes.dropArea.removeEventListener("drop", this.handleDrop, false);
        this.nodes.dropArea.removeEventListener("dragover", this.handleDragover, false);
        this.nodes.dropArea.removeEventListener("dragleave", this.handleDragleave, false);
        this.nodes.dropArea.removeEventListener("dragenter", this.handleDragenter, false);
    }
    ,onrender: function () {
        var self = this;
        self.set('HOSTNAME', HOSTNAME);
        //this.focusFirstElement();
        this.handleDragenter = function (e) {
            console.log('Dragenter')
            self.set('drag', true)
        }
        this.handleDragleave = function (e) {
            console.log('Dragleave')
            self.set('drag', false)
        }

        this.handleDrop = function (e) {
            console.log('skvik',e)
            e.preventDefault();
            e.stopPropagation();
            let dt = e.dataTransfer;
            let files = dt.files;
            self.fire('upload', files);
            return false;
        }
        this.handleDragover = function (e) {
            console.log('Dragover')
            e.preventDefault();
            e.stopPropagation();
            self.set('drag', true)
            return false;
        }
        //console.log('this.nodes.dropArea', this.nodes.dropArea)
        this.nodes.dropArea.addEventListener('drop', this.handleDrop, false);
        this.nodes.dropArea.addEventListener('dragover', this.handleDragover, false);
        this.nodes.dropArea.addEventListener('dragleave', this.handleDragleave, false);
        this.nodes.dropArea.addEventListener('dragenter', this.handleDragenter, false);
        


        this.nodes.file.onchange = function() {
            self.fire('upload')
        };        
        this.singleUpload = function(file){

        }
        this.on('upload', async function(files){
            //console.log(e)
            if (!files){
                var input = document.querySelector('input[type="file"]')
                //console.log('input', input)
                //console.log('input.files', input.files)
                files = input.files;
                //data.append('file', input.files[0])
            }
            izitoast.info({ message: 'Uploading to server, please wait...'});
            var resp;
            for (var i=0; i<files.length;i++){
                var data = new FormData()
                data.append('file', files[i])

                resp = await fetch(HOSTNAME+'uploadfile', {
                    method: 'POST',
                    mode:'no-cors',
                    body: data
                })
                //.then(function(resp){
                    //console.log('up resp',resp)
                    izitoast.success({ message: 'File '+(i+1)+' of '+ files.length+' uploaded.'});
                    //self.fire('refresh')
                    
            }
            resp.text().then(function(id){
                console.log('iidd uploada',id)
                self.set('imgSelect', id)
            })
            self.fire('refresh')
            //return false; 
        })

        this.on('refresh', async function(){
            var [resp, err] = await fetch2('?query=files_get_list')
            if (resp && resp) {
                self.set('rows', resp)
            }
        })
        this.fire('refresh')

        this.on('imgSelect', function(r){
            //console.log('imgSelect',r)
            self.set('imgSelect', r.id)
        })

        this.on('confirm', function(r){
            self.set('path', self.get('imgSelect'))
            //console.log('imgSelect',r)
            self.set('show', false)
        })
        
        this.on('delete', async function(){
            var [resp, err] = await fetch2('?query=files_delete&id='+self.get('imgSelect') )
            if (resp ) {
                self.set('imgSelect', null);
                self.fire('refresh');
                izitoast.success({ message: 'File removed'});
            }
        })

    },        
    data:function() {
            return {
                rows:[],
                path:null,
                imgSelect:null,
                drag:false
            }
        }
    };
    </script>


