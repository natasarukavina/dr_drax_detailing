<section xx class="componentSection">
    <grid style="flex:1; overflow:auto;">
        {{#each cols}}

        {{#if .compType=='TEXT'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 15rem)" type="text" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
        </div>
        {{/if}}

        {{#if .compType=='LONGTEXT'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <textarea style="width: calc(100% - 15rem)" style="min-height: 14rem;" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
        </div>
        {{/if}}
        
        {{#if (.compType=='INTEGER' || .compType=='NUMERIC') && compId!='id' }}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 15rem)" type="number" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}} >
        </div>
        {{/if}}

        {{#if .compType=='DATE'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 15rem)" type="date" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
        </div>
        {{/if}}

        {{#if .compType=='COLOR'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: 8rem" type="text" style="height:3.6rem" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
            <input style="width: calc(100% - 23rem)" type="color" style="height:4rem" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
        </div>
        {{/if}}
        
        {{#if .compType=='IMAGE'}}
        <div col='1/1' style="display:flex;align-items: start;">
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 39rem); margin-right: 1rem;" type="text" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}>
            <button id="browse" style="width: 14rem;" on-click="@this.fire('showFileBrowse', .compId)">Browse
            </button>    
            <img src="{{HOSTNAME}}image.php?id={{row[.compId]}}" alt="{{row[.compId]}}" style="width: 8rem;">
        </div>
        {{/if}}

        {{#if .compType=='DROPDOWN'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <Select style="display: inline-block; width: calc(100% - 15rem)" url="?query={{.lookup_table}}" value={{row[.compId]}} labelf="{{.lookup_field}}" valuef="id" >
                <option disabled selected value="" >Pick</option>
            </Select>             
        </div>
        {{/if}}

        {{#if .compType=='GPS'}}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 23rem)" type="text" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
            <button style="float:right" on-click="@this.fire('showMap', .compId)">Map</button>
        </div>
        {{/if}}

        {{#if .compType=='CHECKBOX'}}
        <div col='1/1'>
            <Checkbox id="{{compId}}" checked={{row[.compId]}}></Checkbox>
            <label for="{{compId}}">{{.nice_name}}</label>
        </div>
        {{/if}}

        {{#if .compType=='RANGE' }}
        <div col='1/1'>
            <label class="l" xx>{{.nice_name}}</label>
            <input style="width: calc(100% - 15rem)" type="range" title="{{.tooltip}}" placeholder="{{.placeholder}}" value={{row[.compId]}}  >
        </div>
        {{/if}}

        <!--            
            {{#if .type=='TEXT' && .name != 'sql_select'}}
            <div col='1/1'>
                <label>{{.name}}</label>
                <input type="text" value={{row[.name]}}  >
            </div>
            {{/if}}

            {{#if .type=='TEXT' && .name == 'sql_select'}}
            <div col='1/1'>
                <label>{{.name}}</label>
                <textarea style="min-height: 14rem;" value={{row[.name]}}  >
            </div>
            {{/if}}
            

            {{#if .type=='INTEGER' }}
            <div col='1/1'>
                <label>{{.name}}</label>
                <input type="number" value={{row[.name]}} >
            </div>
            {{/if}}


            {{#if .type!='INTEGER' && .type!='TEXT' }}
            <div col='1/1'>
                <label>{{.name}}</label>
                <input type="text" value={{row[.name]}} >
            </div>
            {{/if}}
-->
        {{/each}}
    </grid>
    <div xx class="buttonBar">
        <button disabled={{!row.id}} on-click="delete" style="visibility: hidden;">Delete
        </button>    
        <button primary style="width: 14rem;" on-click="save">Save
        </button>    
    </div>

<!--
    <button id="browse" style="width: 14rem;" on-click="@this.set('showModal',true)">Browse
    </button>    
-->                
</section>

{{#if showMap}}
<modal show="{{showMap}}" title="Click on map to set position" 
class="animated fadeInRight" showOverlay="{{true}}" showHeader="{{true}}" style="
height: 40em;
width: 60em;
left: calc(50% - 30em);
right: inherit;
top: calc(50% - 20em);
bottom: inherit;
" >
    <map G={{.}} gps="{{row[mapvarname]}}" show="{{showMap}}"></map>
</modal>  
{{/if}}   


{{#if showFileBrowse}}
<modal show="{{showFileBrowse}}" zoomFrom="browse" cw="{{cw}}" title="Browse" 
class="animated fadeInRight" showOverlay="{{true}}" style="
height: 44em;
width: 50em;
left: calc(50% - 25em);
right: inherit;
top: calc(50% - 22em);
bottom: inherit;" >
    <ImageBrowser path="{{row[pathvarname]}}" show="{{showFileBrowse}}"></ImageBrowser>
</modal>
{{/if}}

<style>
.l{
    width:14rem;
}
.componentSection {
    flex:1; 
    padding-bottom:0; 
    padding:1rem; 
    overflow:auto; 
    display:flex; 
    flex-flow:column; 
    height:100%
}
.buttonBar{
    display:flex; 
    justify-content: space-between; 
    margin-top: 2rem;
}

</style>
<script>
    component.exports = {
    onrender: function () {
        var self = this;
        self.set('HOSTNAME', HOSTNAME);
        TDetails = self;

        this.on('refresh', async function(){
            var selected_tablename = self.get('selected_tablename');
            console.log('refreshing ' + selected_tablename);
            self.set('loading', true)
            var [columns, err] = await fetch2("?query=engine_table_columns_get&table_name="+selected_tablename)
            var [resp,err] = await fetch2('?query='+ selected_tablename)
            self.set('loading', false)
            if (columns) self.set('cols', columns);
            if (resp) self.set('row', resp);
            setTimeout( function() { self.focusFirstElement(self) }, 1);
        })
        this.fire('refresh')
        
        if (false || !self.get('update')){
            // set default values from columns definition
            var cols = self.get('cols');
            var row = {};
            for(var i=0;i<cols.length;i++) {
                row[ cols[i].compId ] = cols[i].default_value;
                if (cols[i].default_value == 'now' && cols[i].compType == 'DATE')
                    row[ cols[i].compId ] = new Date().toISOString().substr(0, 10);
            }
            self.set('row', row);
        }

        this.on('save', async function(){
            var row = self.get('row');
            var cn=[];
            var cu=[];
            var cols = self.get('cols');
            for(var i=0;i<cols.length;i++) 
                if(cols[i].compId!='id' && typeof( row[ cols[i].compId ])!=='undefined' ) {
                    cn.push(cols[i].compId);
                    cu.push(cols[i].compId+' = :'+cols[i].compId); 
                }
            var qinsert = 'insert into '+self.get('selected_tablename') +' (' + cn.join(',') + ') values (:' + cn.join(',:') + ')' 
            var qupdate = 'update '+self.get('selected_tablename') +' set ' + cu.join(',') + ' where id = :id'
            var [resp, err] = await fetch2('?query='+(self.get('row.id')?qupdate:qinsert) , self.get('row'))
            if (resp) {
                izitoast.success({ message: 'Record saved.'});
                if (self.parent) self.parent.fire('refresh');
                self.set('show', false)
            }
        })
    
        this.on('showMap', function(id){
            console.log(id);
            self.set('mapvarname', id)
            self.set('showMap', true)
        })

        this.on('showFileBrowse', function(id){
            console.log(id);
            self.set('pathvarname', id)
            self.set('showFileBrowse', true)
        })
        
    },        
    data:function() {
            return {
                  row:{}
                , columns:[]
                , selected_tablename:null
                , cols:[]
                , update:null
                , mapvarname:''
            }
        }
    };
</script>


