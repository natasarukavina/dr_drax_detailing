
<nav style="z-index: 1044;" id="nav">
    <!-- this label allows the checkbox to be activated by clicking anywhere in the nav -->
    <label>
        <!-- checkbox required for responsiven menu -->
        <input type="checkbox">
        
        <!-- bareCSS will use the header to contain the hamburger menu -->
        <header>
            <!-- you can leave this empty if you don't want a title -->
            <a>
                <img src="favicon.png">
                {{selectedModule?selected_tablename:'Admin Panel'}}
            </a>
            
        </header>
        
        <!-- the main navigation items are anchor links within an unordered list -->
        <ul>
        
            <li>
                <a  on-click="@this.set('selectedModule','ImageBrowser')" style="{{selectedModule=='ImageBrowser'?'border-color: #679;':''}}" >Media</a>
            </li>
        
            <!-- Only SA can update schema-->
            {{#if _session_user_role == 2}}
            <li>
                <a style="{{selectedModule=='Schema'?'border-color: #679;':''}}">Schema</a>                
                <menu>
                    <menuitem><a style="text-transform: capitalize;" on-click="@this.set('showSchemaNew',true)" id="newSchema" >Add New Schema</a></menuitem>
                    {{#each sqlite_schema}}                        
                    <menuitem style="{{(selectedModule=='Schema' && selected_tablename==.name)?'border-color: #679;':''}}"><a style="text-transform: capitalize;" on-click="@this.fire('onModuleSelect',@this.event,'Schema', .name)" >{{.name}}</a></menuitem>
                    {{/each}}
                </menu>
            </li>            
            {{/if}}

            <li>
                <a style="{{selectedModule=='TGrid'?'border-color: #679;':''}}">Tables</a>                
                <menu>
                    {{#each sqlite_tables}}
                    {{#if .is_multiple == 'false'}}
                    <menuitem style="{{(selectedModule=='TDetailsSingle' && selected_tablename==.name)?'border-color: #679;':''}}"><a style="text-transform: capitalize;" on-click="@this.fire('onModuleSelect',@this.event,'TDetailsSingle', .name)" >{{.nice_name}}</a></menuitem>
                    {{else}}
                    <menuitem style="{{(selectedModule=='TGrid' && selected_tablename==.name)?'border-color: #679;':''}}"><a style="text-transform: capitalize;" on-click="@this.fire('onModuleSelect',@this.event,'TGrid', .name)" >{{.nice_name}}</a></menuitem>
                    {{/if}}
                    {{/each}}
                </menu>
            </li>       
            

            <li>
                <a style="{{selectedModule=='UserList'?'border-color: #679;':''}}">Settings</a>                
                <menu>
                    {{#if (_session_user_role == 2) || (_session_user_role == 4) || true}} <!--SA and Owner-->
                    <menuitem style="{{(selectedModule=='UserList')?'border-color: #679;':''}}"><a style="text-transform: capitalize;" on-click="@this.fire('onModuleSelect',@this.event,'UserList', '')" >Users</a></menuitem>
                    {{/if}}
                    <menuitem style="{{(selectedModule=='Login')?'border-color: #679;':''}}"><a style="text-transform: capitalize;" on-click="logout" >Sign out</a></menuitem>
                </menu>
            </li>       
                
                
<!--
            <li on-click="@this.set('selectedModule','settings')"><a style="{{selectedModule=='settings'?'border-color: #679;':''}}">Settings</a></li>            
            <li on-click="logout" ><a style="{{selectedModule=='Login'?'border-color: #679;':''}}" >Sign out</a></li>        
-->
        </ul>
    </label>
</nav>

<!--
                		
{{#if selectedModule && selectedModule != 'settings'}}
<Grid G={{.}} selectedModule={{selectedModule}} rows={{rows[selectedModule]}} ts={{ts[selectedModule]}} columns={{setings[selectedModule].columns}}></Grid>
{{/if}}
-->

{{#if !is_logedin}}
<modal show="{{true}}" title="Login" 
zoomFrom="nav" showOverlay="{{true}}" showHeader="{{true}}" style="
height: 20em;
width: 30em;
left: calc(50% - 15em);
right: inherit;
top: calc(50% - 10em);
bottom: inherit;
" >
    <Login G={{.}} ></Login>
</modal>
{{/if}}

{{#if selectedModule == 'UserList'}}
<UserList G={{.}}></UserList>
{{/if}}

{{#if selectedModule == 'TGrid'}}
<TGrid G={{.}} selected_tablename = {{selected_tablename}}></TGrid>
{{/if}}

{{#if selectedModule == 'TDetailsSingle'}}
<TDetailsSingle G={{.}} selected_tablename = {{selected_tablename}}></TDetailsSingle>
{{/if}}

{{#if selectedModule == 'ImageBrowser'}}
<ImageBrowser G={{.}}></ImageBrowser>
{{/if}}

{{#if selectedModule == 'Schema'}}
<Schema G={{.}} schema_name = {{selected_tablename}}></Schema>
{{/if}}


{{#if showSchemaNew }}
<modal show="{{showSchemaNew}}" zoomFrom="newSchema" title="Create New Schema" 
class="animated fadeInRight" showOverlay="{{true}}" showHeader="{{true}}" style="
height: 20em;
width: 30em;
left: calc(50% - 15em);
right: inherit;
top: calc(50% - 10em);
bottom: inherit;
" >
    <SchemaNew G={{.}} show="{{showSchemaNew}}"></SchemaNew>
</modal>
{{/if}}

<script>
  component.exports = {
    onrender: function () {
        var self = this;

        this.on('refresh', async function(){
            console.log('refreshing sqlite tables')
            var [resp,err] = await fetch2("?query=cms_tables_list_get")
            if (resp) self.set('sqlite_tables', resp)
            if (resp) self.set('sqlite_schema', resp)

            // TODO: popravi, odje ne trebaju 2 poziva
            var [resparr, err] = await fetch2('?query=_engine_schema');
            if (resparr){
                var respkv={}
                for (var i=0; i<resparr.length;i++)
                    respkv[ resparr[i].name ] = resparr[i];
                self.set('schemas', respkv);
            }                
        })

        this.observe('is_logedin', function(n,o){
            if (n) self.fire('refresh');
            self.set('selectedModule','TDetailsSingle'); // default (first), TODO
        }, {init:false})

        //this.fire('refresh')

        this.on('onModuleSelect', function(e, component, tablename){
            //"@this.set('selectedModule','settings')
            console.log(e, component,tablename );
            //e.original.stopImmediatePropagation()
            //e.original.preventDefault();
            //e.original.stopPropagation();
            self.set('selectedModule', null).then(function(){
                self.set('selected_tablename', tablename);
                self.set('selectedModule', component);
            })
            return true
        })

        this.on('logout', async function(n,o,k,i){
            var [resp,err] = await fetch2("?query=_session_destroy")
            self.set('_session_user_name', null);
            self.set('_session_user_role', null);
            self.set('is_logedin',false);
            document.location = document.location;
        })
        
    },        
    data:function() {
            return {    
                selectedModule:'',   
                QRScannerActive:false,
                company_id:'',   
                is_logedin:false,
                kvStore:{}, 
                sqlite_tables:[],
                sqlite_schema:[],
                selected_tablename:'Home',
                showSchemaNew:false,

            }
        }
  };
  </script>